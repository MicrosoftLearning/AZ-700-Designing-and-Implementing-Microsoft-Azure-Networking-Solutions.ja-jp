---
Exercise:
  title: M04 - ユニット 6 Azure portal を使用して Traffic Manager プロファイルを作成する
  module: Module 04 - Load balancing non-HTTP(S) traffic in Azure
---

# M04-ユニット 6 Azure portal を使用して Traffic Manager プロファイルを作成する

## 演習のシナリオ

この演習では、架空の組織 Contoso Ltd の Web アプリケーションに高い可用性をもたらす Traffic Manager プロファイルを作成します。

   >**メモ:** このラボをご自分のペースでクリックして進めることができる、 **[ラボの対話型シミュレーション](https://mslabs.cloudguides.com/guides/AZ-700%20Lab%20Simulation%20-%20Create%20a%20Traffic%20Manager%20profile%20using%20the%20Azure%20portal)** が用意されています。 対話型シミュレーションとホストされたラボの間に若干の違いがある場合がありますが、示されている主要な概念とアイデアは同じです。

### 推定時間: 35 分

2 つの異なるリージョン (米国東部と西ヨーロッパ) にデプロイされた Web アプリケーションの 2 つのインスタンスを作成します。 米国東部リージョンは Traffic Manager のプライマリ エンドポイントとして、西ヨーロッパ リージョンはフェールオーバー エンドポイントとして機能します。

その後、エンドポイントの優先度に基づいて、Traffic Manager プロファイルを作成します。 このプロファイルにより、Web アプリケーションが実行されているプライマリ サイトにユーザー トラフィックが誘導されます。 Traffic Manager では Web アプリケーションを継続的に監視し、米国東部のプライマリ サイトが使用できない場合は、西ヨーロッパのバックアップ サイトに自動的にフェールオーバーします。

以下の概略図は、この演習でデプロイする環境を示しています。

 ![画像 14](../media/exercise-traffic-manager-environment-diagram.png)

 この演習では、以下のことを行います。

+ タスク 1: Web アプリを作成する
+ タスク 2: Traffic Manager プロファイルを作成する
+ タスク 3:Traffic Manager エンドポイントの追加
+ タスク 4: Traffic Manager プロファイルをテストする

## タスク 1: Web アプリを作成する

このセクションでは、2 つの異なる Azure リージョンにデプロイされた Web アプリケーションの 2 つのインスタンスを作成します。

1. Azure portal のホーム ページで、**[リソースの作成]** を選択し、**[Web アプリ]** を選択します (このリソースの種類がページに表示されていない場合は、ページの上部にある [検索] ボックスを使用してそれを検索し、選択します)。

1. **[Web アプリの作成]** ページの **[基本]** タブで、次の表の情報を使用して最初の Web アプリケーションを作成します。

   | **設定**      | **Value**                                                    |
   | ---------------- | ------------------------------------------------------------ |
   | サブスクリプション     | サブスクリプションを選択します。                                     |
   | Resource group   | **[新規作成]** を選択  名前: **Contoso-RG-TM1**             |
   | 名前             | **ContosoWebAppEastUSxx** (xx は、名前を一意にするための自分のイニシャルです) |
   | 発行          | **コード**                                                     |
   | ランタイム スタック    | **ASP.NET V4.8**                                             |
   | オペレーティング システム | **Windows**                                                  |
   | リージョン           | **米国東部**                                                  |
   | Windows プラン     | **[新規作成]** を選択  名前: **ContosoAppServicePlanEastUS** |
   | 料金プラン     | **[Standard S1 100 total ACU, 1.75-GB  memory](Standard S1 合計 100 ACU、1.75 GB メモリ)**               |

1. **[監視]** タブを選択します。

1. **[監視]** タブの **[Application Insights を有効にする]** で、**[いいえ]** のオプションを選択します。

1. **[Review + create](レビュー + 作成)** を選択します。

   ![画像 18](../media/create-web-app-1.png)

1. **作成** を選択します。 Web アプリが正常にデプロイされると、既定の Web サイトが作成されます。

1. 前述の手順 1 から 6 を繰り返して、2 つ目の Web アプリを作成します。 以下の表の情報を除き、前と同じ設定を使用します。

   | **設定**    | **Value**                                                    |
   | -------------- | ------------------------------------------------------------ |
   | Resource group | **[新規作成]** を選択  名前: **Contoso-RG-TM2**             |
   | 名前           | **ContosoWebAppWestEuropexx** (xx は、名前を一意にするための自分のイニシャルです)  |
   | リージョン         | "**西ヨーロッパ**"                                              |
   | Windows プラン   | **[新規作成]** を選択  名前: **ContosoAppServicePlanWestEurope** |

1. Azure のホーム ページで、**[すべてのサービス]** を選択し、左側のナビゲーション メニューで **[Web]** を選択してから、**[App Services]** を選択します。

1. 2 つの新しい Web アプリが一覧に表示されます。

   ![画像 19](../media/create-web-app-2.png)

## タスク 2: Traffic Manager プロファイルを作成する

次は、エンドポイントの優先度に基づいてユーザー トラフィックを誘導する Traffic Manager プロファイルを作成します。

1. Azure portal のホーム ページで **[リソースの作成]** を選択します。

1. ページの上部にある検索ボックスに、「**Traffic Manager プロファイル**」と入力して、ポップアップ リストからそれを選択します。

   ![画像 20](../media/create-tmprofile-1.png)

1. **作成** を選択します。

1. **[Traffic Manager プロファイルの作成]** ページで、以下の表の情報を使用して、Traffic Manager プロファイルを作成します。

   | **設定**             | **Value**                |
   | ----------------------- | ------------------------ |
   | 名前                    | **Contoso-TMProfilexx** (xx は、名前を一意にするための自分のイニシャルです) |
   | ルーティング方法          | **優先順位**             |
   | サブスクリプション            | サブスクリプションを選択します。 |
   | Resource group          | **Contoso-RG-TM1**       |
   | リソース グループの場所 | **米国東部**              |

1. **作成** を選択します。

## タスク 3: Traffic Manager エンドポイントを追加する

このセクションでは、すべてのユーザー トラフィックをルーティングするプライマリ エンドポイントとして、米国東部の Web サイトを追加します。 次に、フェールオーバー エンドポイントとして、西ヨーロッパの Web サイトを追加します。 プライマリ エンドポイントが使用できなくなった場合、トラフィックは自動的にフェールオーバー エンドポイントにルーティングされます。

1. Azure portal のホームページで、**[すべてのリソース]** を選択し、リソースの一覧で **[Contoso-TMProfile]** を選択します。

1. **[設定]** で、**[エンドポイント]** を選択し、**[追加]** を選択します。

   ![画像 21](../media/create-tmendpoints-1.png)

1. **[エンドポイントの追加]** ページで、以下の表の情報を入力します。

   | **設定**          | **Value**                         |
   | -------------------- | --------------------------------- |
   | Type                 | **Azure エンドポイント**                |
   | 名前                 | **myPrimaryEndpoint**             |
   | ターゲット リソースの種類 | **App Service**                   |
   | ターゲット リソース      | **ContosoWebAppEastUS (米国東部)** |
   | 優先度             | **1**                             |

1. **[追加]** を選択します。

1. 前述の手順 2 から 4 を繰り返して、フェールオーバー エンドポイントを作成します。 以下の表の情報を除き、前と同じ設定を使用します。

   | **設定**     | **Value**                                 |
   | --------------- | ----------------------------------------- |
   | 名前            | **myFailoverEndpoint**                    |
   | ターゲット リソース | **ContosoWebAppWestEurope (西ヨーロッパ)** |
   | 優先度        | **2**                                     |

1. 優先順位を 2 に設定すると、構成されたプライマリ エンドポイントで異常が発生した場合に、トラフィックがこのフェールオーバー エンドポイントにルーティングされます。

1. **[設定]** で **[構成]** を選択してから、エンドポイント モニター設定の **[プロトコル]** を [HTTPS] に、 **[ポート]** を 443 に更新し、 **[保存]** を選択します。

1. 2 つの新しいエンドポイントが Traffic Manager プロファイルに表示されます。 数分後に **[監視状態]** が **[オンライン]** に変更される点に注目してください。

   ![画像 22](../media/create-tmendpoints-2.png)

## タスク 4: Traffic Manager プロファイルをテストする

このセクションでは、Traffic Manager プロファイルの DNS 名を確認し、プライマリ エンドポイントが使用できなくなるように構成します。 次に、Traffic Manager プロファイルによってトラフィックがフェールオーバー エンドポイントに正常に送信されているかどうかをテストするために、Web アプリが引き続き使用可能であることを確認します。

1. **[Contoso-TMProfile]** ページで、**[概要]** を選択します。

1. **[概要]** 画面で、**DNS 名**のエントリをクリップボードにコピーします (または、どこかに書き留めておきます)。

   ![画像 23](../media/check-dnsname-1.png)

1. Web ブラウザーのタブを開き、**DNS 名**のエントリ (contoso-tmprofile.trafficmanager.net) をアドレス バーに貼り付け (または入力して)、Enter キーを押します。

1. その Web アプリの既定の Web サイトが表示されます。 " **404 Web サイトが見つかりません**" というメッセージが表示された場合は、**Contoso-TMProfilexx** Traffic Manager のプロファイルの概要ページから**プロファイルを無効化**し、**プロファイルを有効化**します。 その後、Web ページを更新します。

   ![画像 24](../media/tm-webapp-test-1a.png)

1. 現時点では、**[優先順位]** が **[1]** に設定されているため、すべてのトラフィックがプライマリ エンドポイントに送信されます。

1. フェールオーバー エンドポイントが正常に動作していることをテストするには、プライマリ サイトを無効にする必要があります。

1. **[Contoso-TMProfile]** ページの [概要] 画面で、**[myPrimaryEndpoint]** を選択します。

1. **[myPrimaryEndpoint]** ページの **[状態]** で、**[無効]** を選択し、**[保存]** を選択します。

   ![画像 25](../media/disable-primary-endpoint-1.png)

1. **[myPrimaryEndpoint]** ページを閉じます (ページの右上隅にある **[X]** を選択します)。

1. これで **[Contoso-TMProfile]** ページで、**myPrimaryEndpoint** の **[監視状態]** が **[無効]** になっているはずです。

1. Web ブラウザーの新しいセッションを開き、**DNS 名**のエントリ (contoso-tmprofile.trafficmanager.net) をアドレス バーに貼り付け (または入力して)、Enter キーを押します。

1. Web アプリからまだ応答があることを確認します。 プライマリ エンドポイントを使用できなかったため、Web サイトを引き続き利用できるように、トラフィックが代わりにフェールオーバー エンドポイントにルーティングされました。

## リソースをクリーンアップする

   >**注**:新規に作成し、使用しなくなったすべての Azure リソースを削除することを忘れないでください。 使用していないリソースを削除することで、予期しない料金が発生しなくなります。

1. Azure portal で、 **[Cloud Shell]** ペイン内に **PowerShell** セッションを開きます。

1. 次のコマンドを実行して、このモジュールのラボ全体を通して作成したすべてのリソース グループを削除します。

   ```powershell

   Remove-AzResourceGroup -Name 'Contoso-RG-TM1' -Force -AsJob
   Remove-AzResourceGroup -Name 'Contoso-RG-TM2' -Force -AsJob

   ```

   >**注**:このコマンドは非同期で実行されるため (-AsJob パラメーターによって決定されます)、同じ PowerShell セッション内で直後に別の PowerShell コマンドを実行できますが、リソース グループが実際に削除されるまでに数分かかります。

## Copilot を使用して学習を拡張する

Copilot は、Azure スクリプト ツールの使用方法を学習するのに役立ちます。 Copilot は、ラボでは対象外の、またはさらに詳しい情報が必要な領域でも役立ちます。 Edge ブラウザーを開き、Copilot (右上) を選択するか、*copilot.microsoft.com* に移動します。 次のプロンプトを試すには数分かかります。
+ Azure Traffic Manager を構成するための大まかな手順は何ですか?
+ Azure Load Balancer および Azure Traffic Manager を使用する状況を比較対照してください。
+ Traffic Manager ルーティング プロファイルとその使用すべき状況について説明してください。

## 自習トレーニングでさらに学習する

+ [Azure Traffic Manager を使用してサービスの可用性とデータの局所性を強化する](https://learn.microsoft.com/training/modules/distribute-load-with-traffic-manager/)。 このモジュールでは、Traffic Manager を使用してネットワーク トラフィックを動的に分散させる方法について説明しています。
+ [Azure での非 HTTP(S) トラフィックの負荷分散](https://learn.microsoft.com/training/modules/load-balancing-non-https-traffic-azure/)。 このモジュールでは、Azure Traffic Manager とルーティング方法の実装について説明しています。 

## 要点

以上でラボは完了です。 このラボの要点は次のとおりです。 
+ Azure Traffic Manager は、DNS ベースのトラフィック ロード バランサーです。 このサービスを使用すると、パブリックに公開されているアプリケーションへのトラフィックを世界各国の Azure リージョン全体に分散することができます。
+ Traffic Manager には、Traffic Manager が各エンド ユーザーからのトラフィックを受信するエンドポイントを選択する方法を制御できるトラフィック ルーティング方法が 6 つあります。 いくつ挙げることができますか?
+ Traffic Manager プロファイルを入れ子にして、複数のトラフィック ルーティング方法の利点を組み合わせることができます。 入れ子になったプロファイルを使用すると、既定の Traffic Manager の動作をオーバーライドして、より大規模でより複雑なアプリケーションのデプロイに対応することができます。
