---
Exercise:
  title: M05 - ユニット 4 Azure Application Gateway をデプロイする
  module: Module 05 - Load balancing HTTP(S) traffic in Azure
---

# M05-ユニット 4 Azure Application Gateway をデプロイする
 

この演習では、Azure portal を使用してアプリケーション ゲートウェイを作成します。 さらに、それをテストし、正しく動作することを確認します。

![アプリケーション ゲートウェイ アーキテクチャの図。](../media/4-exercise-deploy-azure-application-gateway.png)


>**メモ:** このラボをご自分のペースでクリックして進めることができる、 **[ラボの対話型シミュレーション](https://mslabs.cloudguides.com/guides/AZ-700%20Lab%20Simulation%20-%20Deploy%20Azure%20Application%20Gateway)** が用意されています。 対話型シミュレーションとホストされたラボの間に若干の違いがある場合がありますが、示されている主要な概念とアイデアは同じです。

#### 推定時間: 25 分

アプリケーション ゲートウェイは、アプリケーション Web トラフィックをバックエンド プール内の特定のリソースに転送します。 リスナーをポートに割り当て、ルールを作成し、リソースをバックエンド プールに追加します。 わかりやすくするために、この記事では、パブリック フロントエンド IP、アプリケーション ゲートウェイで単一サイトをホストするための基本リスナー、基本要求ルーティング規則、およびバックエンド プール内の 2 つの仮想マシンを使用する簡単な設定を使用します。

お客様が作成するリソースの間で Azure による通信が行われるには、仮想ネットワークが必要です。 新しい仮想ネットワークを作成することも、既存の仮想ネットワークを使用することもできます。 この例では、アプリケーション ゲートウェイの作成時に新しい仮想ネットワークを作成します。 Application Gateway インスタンスは、個別のサブネットに作成されます。 この例では 2 つのサブネットを作成します。1 つはアプリケーション ゲートウェイ用で、もう 1 つはバックエンド サーバー用です。

この演習では、以下のことを行います。

+ タスク 1: アプリケーション ゲートウェイを作成する
+ タスク 2:仮想マシンを作成する
+ タスク 3: バックエンド プールにバックエンド サーバーを追加する
+ タスク 4: アプリケーション ゲートウェイをテストする


## タスク 1: アプリケーション ゲートウェイを作成する

1. Azure アカウントで [Azure Portal](https://portal.azure.com/) にサインインします。

1. Azure portal ページの「**リソース、サービス、ドキュメントの検索 (G+/)** 」で、アプリケーションゲートウェイと入力し、結果から「**アプリケーションゲートウェイ**」を選択します。
    ![Azure portal 上でアプリケーション ゲートウェイを検索する](../media/search-application-gateway.png)    

1. アプリケーション ゲートウェイのページで、**[+ 作成]** を選択します。

1. [アプリケーション ゲートウェイの作成] の **[基本]** タブで、次の情報を入力または選択します。

   | **設定**         | **Value**                                    |
   | ------------------- | -------------------------------------------- |
   | サブスクリプション        | サブスクリプションを選択します。                    |
   | Resource group      | [新規作成]、[ContosoResourceGroup] を選択します       |
   | Application Gateway | ContosoAppGateway                            |
   | リージョン              | **[米国東部]** を選択します。                           |
   | Virtual Network     | **[新規作成]** を選択します                        |

1. [仮想ネットワークの作成] で、次の情報を入力または選択します。

   | **設定**       | **Value**                          |
   | ----------------- | ---------------------------------- |
   | 名前              | ContosoVNet                        |
   | **アドレス空間** |                                    |
   | アドレス範囲     | 10.0.0.0/16                        |
   | **サブネット**       |                                    |
   | サブネット名       | **既定値**を **[AGSubnet]** に変更します |
   | アドレス範囲     | 10.0.0.0/24                        |
   | サブネット名       | BackendSubnet                      |
   | アドレス範囲     | 10.0.1.0/24                        |


>**注**: 追加のサブネットを追加するオプションが UI にない場合は、ゲートウェイ作成後に、手順を完了して、バックエンド サブネットを追加します。 

1. **[OK]** を選択して、[アプリケーション ゲートウェイの作成] の [基本] タブに戻ります。

1. 他の設定は既定値をそのまま使用し、 **[次へ:フロントエンド]** を選択します。

1. **[フロントエンド]** タブで、 **[フロントエンド IP アドレスの種類]** が **[パブリック]** に設定されていることを確認します。

1. **[パブリック IP アドレス]** で **[新規追加]** を選択し、パブリック IP アドレス名として「AGPublicIPAddress」を入力して **[OK]** を選択します。

1. **バックエンド** を選択します。

1. **[バックエンド]** タブで、 **[バックエンド プールの追加]** を選択します。

1. **[バックエンド プールの追加]** ウィンドウが開いたら、次の値を入力して、空のバックエンド プールを作成します。

    | **設定**                      | **Value**   |
    | -------------------------------- | ----------- |
    | 名前                             | BackendPool |
    | [Add backend pool without targets](ターゲットを持たないバックエンド プールを追加する) | はい         |

1. **[バックエンド プールの追加]** ウィンドウで、 **[追加]** を選択し、バックエンド プール構成を保存して、 **[バックエンド]** タブに戻ります。

1. **[バックエンド]** タブで、 **[次へ:構成]** を選択します。

1. **[構成]** タブで、ルーティング規則を使用して作成したフロントエンドとバックエンド プールを接続します。

1. **[ルーティング規則]** 列で **[ルーティング規則の追加]** を選択します。

1. **[規則名]** ボックスに「**RoutingRule**」と入力します。

1. **[リスナー]** タブで、次の情報を入力または選択します。

    | **設定**   | **Value**         |
    | ------------- | ----------------- |
    | リスナー名 | リスナー          |
    | Priority      | **100**           |
    | フロントエンド IP   | **[Public]** を選択します |

1. **[リスナー]** タブの他の設定に対しては、既定値をそのまま使用します。

    ![Azure portal は Application Gateway ルーティング規則を追加する](../media/Routing-rule-listener-tab.png)

1. **[バックエンド ターゲット]** タブを選択して、残りのルーティング規則を構成します。

1. **[バックエンド ターゲット]** タブで、次の情報を入力または選択します。

    | **設定**      | **Value**      |
    | -------------    | -------------- |
    | 変換後の型      | バックエンド プール   |
    | バックエンド設定 | **[新規追加]** |

1. **[バックエンド設定の追加]** で、次の情報を入力または選択します。

    | **設定**          | **Value**   |
    | ------------------   | ----------- |
    | バックエンド設定の名前 | HTTPSetting |
    | バックエンド ポート         | 80          |

1. **[バックエンド設定の追加]** ウィンドウの他の設定に対しては既定値をそのまま使用し、 **[追加]** を選択して **[ルーティング規則の追加]** に戻ります。

1. **[追加]** を選択してルーティング規則を保存し、**[構成]** タブに戻ります。

1. **タグ**、**次へ:確認と作成** をクリックします。

1. **[確認および作成]** タブで設定を確認します。

1. **[作成]** を選択して、仮想ネットワーク、パブリック IP アドレス、アプリケーション ゲートウェイを作成します。 

Azure によるアプリケーション ゲートウェイの作成には数分かかる場合があります。 次のセクションに進む前に、デプロイが正常に完了するまで待機します。

## タスク 2:仮想マシンを作成する

1. Azure portal の **[Cloud Shell]** ペイン内で **PowerShell** セッションを開きます。
 > **注:**  Cloud Shell を開いたのが初めてである場合、ストレージ アカウントを作成するよう求められる場合があります。 **[Create storage](ストレージの作成)** を選択します。
1. [Cloud Shell] ペインのツール バーで、 **[ファイルのアップロード/ダウンロード]** アイコンを選択し、ドロップダウン メニューで **[アップロード]** を選択して、**backend.json** ファイルと **backend.parameters.json** ファイルを、ソース フォルダー **F:\Allfiles\Exercises\M05** から Cloud Shell のホーム ディレクトリに 1 つずつアップロードします。

1. 次の ARM テンプレートをデプロイして、この演習に必要な VM を作成します。

>**注**: 管理者パスワードを入力するように求められます。

   ```powershell
   $RGName = "ContosoResourceGroup"
   
   New-AzResourceGroupDeployment -ResourceGroupName $RGName -TemplateFile backend.json -TemplateParameterFile backend.parameters.json
   ```
  
1. デプロイが完了したら、Azure portal のホーム ページに移動し、**[仮想マシン]** を選択します。

1. 両方の仮想マシンが作成されていることを確認します。

## タスク 3: バックエンド プールにバックエンド サーバーを追加する

1. Azure portal メニューで **[すべてのリソース]** を選択するか、または [すべてのリソース] を検索して選択します。 次に **[ContosoAppGateway]** を選択します。

1. **[設定]** で、 **[バックエンド プール]** を選択します。

1. **[BackendPool]** を選択します。

1. [バックエンド プールの編集] ページの **[バックエンド ターゲット]** にある **[ターゲットの種類]** で、**[仮想マシン]** を選択します。

1. **[ターゲット]** で **[BackendVM1]** を選択します。 

1. **[ターゲットの種類]** で、 **[仮想マシン]** を選択します。

1. **[ターゲット]** で **[BackendVM2]** を選択します。 

   ![Azure portal はターゲット バックエンドをバックエンド プールに追加します](../media/edit-backend-pool.png)

1. **[保存]** を選択します。

デプロイが完了するまで待ってから次の手順に進んでください。

## タスク 4: アプリケーション ゲートウェイをテストする

IIS はアプリケーション ゲートウェイを作成するのに必要ではありませんが、この演習では、Azure によってアプリケーション ゲートウェイが正常に作成されたかどうかを確認するためにインストールしました。

### IIS を使用してアプリケーション ゲートウェイをテストします。

1. **[概要]** ページで、アプリケーション ゲートウェイのパブリック IP アドレスを見つけます。 

   ![Azure portal はフロントエンド パブリック IP アドレスを検索します ](../media/app-gw-public-ip.png)

1. パブリック IP アドレスをコピーし、お使いのブラウザーのアドレス バーに貼り付けて、その IP アドレスを開きます。

1. 応答を確認します。 有効な応答によって、アプリケーション ゲートウェイが正常に作成されたことが確認され、それによりバックエンドに正常に接続できます。

   ![ブラウザー - 要求に応答するバックエンド サーバーに応じて、BackendVM1 または BackendVM2 が表示される。](../media/browse-to-backend.png)

1. ブラウザーを何度か更新すると、BackendVM1 と BackendVM2 の両方への接続が表示されます。

お疲れさまでした。 これで、Azure Application Gateway の構成とテストが完了しました。
